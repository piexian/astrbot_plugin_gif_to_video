name: Auto Tag on Version Update

on:
  push:
    branches: [ master, main ]
    paths:
      - 'metadata.yaml'

jobs:
  auto-tag:
    runs-on: ubuntu-latest
    container: python:3.11-slim
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ä»¥ä¾¿æ¯”è¾ƒ

    - name: Install git
      run: |
        apt-get update
        apt-get install -y git
        
    - name: Install PyYAML
      run: pip install PyYAML
      
    - name: Extract version from metadata.yaml
      id: get-version
      run: |
        python3 -c "import yaml; f=open('metadata.yaml', 'r'); data=yaml.safe_load(f); f.close(); version=data.get('version', ''); print(f'VERSION={version}') if version else None" >> $GITHUB_OUTPUT
        
    - name: Check if tag already exists
      id: check-tag
      run: |
        VERSION='${{ steps.get-version.outputs.VERSION }}'
        if git rev-parse "refs/tags/$VERSION" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Create and push tag
      if: steps.check-tag.outputs.exists == 'false'
      run: |
        VERSION='${{ steps.get-version.outputs.VERSION }}'
        echo "Creating tag v$VERSION"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "v$VERSION" -m "v$VERSION: è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬"
        git push origin "v$VERSION"
        
    - name: Read Changelog
      if: steps.check-tag.outputs.exists == 'false'
      id: read-changelog
      run: |
        VERSION="${{ steps.get-version.outputs.VERSION }}"
        # æå–CHANGELOG.mdä¸­å¯¹åº”ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
        # ä½¿ç”¨sedæå–ä»"## [${VERSION}]"å¼€å§‹åˆ°ä¸‹ä¸€ä¸ª"## ["æˆ–æ–‡ä»¶ç»“å°¾çš„å†…å®¹
        sed -n "/^## \[${VERSION}\]/,/^## \[/p" CHANGELOG.md | sed '$d' > changelog_${VERSION}.md
        # å¦‚æœæ–‡ä»¶ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤æ¶ˆæ¯
        if [ ! -s "changelog_${VERSION}.md" ]; then
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "# AstrBot GIFè½¬è§†é¢‘æ’ä»¶ v${VERSION} å‘å¸ƒ" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ğŸ‰ ç‰ˆæœ¬æ›´æ–°" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "AstrBot GIFè½¬è§†é¢‘æ’ä»¶ v${VERSION} ç°å·²å‘å¸ƒï¼æœ¬æ¬¡æ›´æ–°ä¸»è¦åŒ…å«ä»¥ä¸‹æ”¹è¿›å’Œä¿®å¤ã€‚" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "æŸ¥çœ‹CHANGELOG.mdäº†è§£è¯¦ç»†ä¿¡æ¯ã€‚" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          # æ·»åŠ ç‰ˆæœ¬æ ‡é¢˜
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "# AstrBot GIFè½¬è§†é¢‘æ’ä»¶ v${VERSION} å‘å¸ƒ" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          cat "changelog_${VERSION}.md" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ğŸ“¦ å®‰è£…å’Œæ›´æ–°" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### æ›´æ–°ç°æœ‰å®‰è£…" >> $GITHUB_OUTPUT
          echo "å¦‚æœæ‚¨å·²ç»å®‰è£…äº†ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ›´æ–°ï¼š" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "1. åœ¨AstrBot WebUIçš„æ’ä»¶ç®¡ç†é¡µé¢æ‰¾åˆ°æ­¤æ’ä»¶" >> $GITHUB_OUTPUT
          echo "2. ç‚¹å‡»\"ç®¡ç†\" â†’ \"é‡è½½æ’ä»¶\"" >> $GITHUB_OUTPUT
          echo "3. æˆ–è€…é‡æ–°å…‹éš†/ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„æ’ä»¶" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### å…¨æ–°å®‰è£…" >> $GITHUB_OUTPUT
          echo "1. ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„æ’ä»¶åˆ°AstrBotçš„pluginsç›®å½•" >> $GITHUB_OUTPUT
          echo "2. ç¡®ä¿å·²å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆFFmpegå’ŒPythonåŒ…ï¼‰" >> $GITHUB_OUTPUT
          echo "3. é‡å¯AstrBotæˆ–é‡è½½æ’ä»¶" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi
        
    - name: Create Release
      if: steps.check-tag.outputs.exists == 'false'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get-version.outputs.VERSION }}
        name: v${{ steps.get-version.outputs.VERSION }}
        body: ${{ steps.read-changelog.outputs.changelog }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
