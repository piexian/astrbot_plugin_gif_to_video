name: Auto Tag on Version Update

on:
  push:
    branches: [ master, main ]
    paths:
      - 'metadata.yaml'

jobs:
  auto-tag:
    runs-on: ubuntu-latest
    container: python:3.11-slim
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ä»¥ä¾¿æ¯”è¾ƒ
        
    - name: Install PyYAML
      run: pip install PyYAML
      
    - name: Extract version from metadata.yaml
      id: get-version
      run: |
        python3 -c "import yaml; f=open('metadata.yaml', 'r'); data=yaml.safe_load(f); f.close(); version=data.get('version', ''); print(f'VERSION={version}') if version else None" >> $GITHUB_OUTPUT
        
    - name: Check if tag already exists
      id: check-tag
      run: |
        VERSION='${{ steps.get-version.outputs.VERSION }}'
        if git rev-parse "refs/tags/$VERSION" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Create and push tag
      if: steps.check-tag.outputs.exists == 'false'
      run: |
        VERSION='${{ steps.get-version.outputs.VERSION }}'
        echo "Creating tag v$VERSION"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "v$VERSION" -m "v$VERSION: è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬"
        git push origin "v$VERSION"
        
    - name: Create Release
      if: steps.check-tag.outputs.exists == 'false'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get-version.outputs.VERSION }}
        name: v${{ steps.get-version.outputs.VERSION }}
        body: |
          # AstrBot GIFè½¬è§†é¢‘æ’ä»¶ v${{ steps.get-version.outputs.VERSION }} å‘å¸ƒ
          
          ## ğŸ‰ ç‰ˆæœ¬æ›´æ–°
          
          AstrBot GIFè½¬è§†é¢‘æ’ä»¶ v${{ steps.get-version.outputs.VERSION }} ç°å·²å‘å¸ƒï¼
          

        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}